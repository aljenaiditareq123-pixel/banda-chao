# üöÄ Production Stabilization Plan - Banda Chao

**Date:** January 2025  
**Status:** Active Stabilization  
**Goal:** Stabilize production deployment on Render

---

## üìã Critical Issues Identified

### 1. ‚ö†Ô∏è **Dual Prisma Schema Conflict** (CRITICAL)
**Issue:** Two Prisma schemas exist and are out of sync:
- `prisma/schema.prisma` (root) - Last updated: Jan 2025, more comprehensive
- `server/prisma/schema.prisma` - Last updated: Dec 2025, older version

**Impact:** Database schema mismatches, migration failures, "Column does not exist" errors

**Solution:** 
- ‚úÖ **Backend** uses `server/prisma/schema.prisma` (as per `server/package.json`)
- ‚ùå **Frontend** should NOT use Prisma directly - remove root `prisma/schema.prisma` OR sync it
- ‚úÖ Sync server schema with root schema (if root is source of truth)

**Action Required:**
```bash
# Option 1: Copy root schema to server (if root is source of truth)
cp prisma/schema.prisma server/prisma/schema.prisma

# Option 2: Remove root schema if frontend doesn't need it
# Verify frontend doesn't import @prisma/client directly
```

---

### 2. üîí **CORS Configuration** (SECURITY)
**Issue:** CORS is temporarily allowing ALL origins (`if (true)` hack)

**Location:** `server/src/index.ts:182`

**Impact:** Security vulnerability, allows any origin to access API

**Solution:** 
- Remove temporary `if (true)` bypass
- Properly implement allowed origin checking
- Test with production frontend URL

**Action Required:**
```typescript
// Remove this:
if (true) { // Temporarily always allow
  callback(null, true);
  return;
}

// Use proper origin checking instead
```

---

### 3. üóÑÔ∏è **Database Migration Strategy** (STABILITY)
**Issue:** Using `prisma db push` in production, which can cause data loss

**Location:** `server/package.json:10` (postbuild script)

**Impact:** Schema changes can cause "Column does not exist" errors, requires `--force-reset`

**Solution:**
- Use `prisma migrate deploy` for production (already in postbuild)
- Keep `db push` as fallback only for emergency fixes
- Document migration workflow

**Action Required:**
- ‚úÖ Already using `migrate deploy` first, then `db push` as fallback
- ‚ö†Ô∏è Monitor for migration failures and improve error handling

---

### 4. üîë **Environment Variables** (CRITICAL)
**Issue:** Missing or incorrect environment variables can cause deployment failures

**Required Variables:**

#### Backend (Render Dashboard)
```env
# Database (CRITICAL)
DATABASE_URL=postgresql://... (from Render PostgreSQL)

# Authentication (CRITICAL)
JWT_SECRET=<strong-random-secret>
JWT_EXPIRES_IN=7d

# Frontend URL (for CORS)
FRONTEND_URL=https://banda-chao-frontend.onrender.com

# Node Environment
NODE_ENV=production
PORT=10000 (auto-set by Render)

# Stripe (if using)
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_MODE=production

# Google Cloud Storage (if using)
GCLOUD_PROJECT_ID=banda-chao
GCS_BUCKET_NAME=banda-chao-uploads-tareq
GCS_SERVICE_ACCOUNT_KEY=<json-key>

# AI Services (optional)
GEMINI_API_KEY=...
GOOGLE_SPEECH_API_KEY=...

# Sentry (optional)
SENTRY_DSN=...
```

#### Frontend (Render Dashboard)
```env
# Backend API
NEXT_PUBLIC_API_URL=https://banda-chao-backend.onrender.com

# Frontend URL
NEXT_PUBLIC_FRONTEND_URL=https://banda-chao-frontend.onrender.com

# Stripe (if using)
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...

# NextAuth
AUTH_URL=https://banda-chao-frontend.onrender.com
AUTH_SECRET=<auto-generated>
NEXTAUTH_URL=https://banda-chao-frontend.onrender.com
NEXTAUTH_SECRET=<auto-generated>

# Database (for Prisma generate - if frontend uses it)
DATABASE_URL=<same as backend>

# Node Environment
NODE_ENV=production
PORT=3000
```

**Action Required:**
- ‚úÖ Create environment variable validation script
- ‚úÖ Document all required variables
- ‚úÖ Test deployment with minimal variables

---

### 5. üíß **Hydration Mismatch Prevention** (STABILITY)
**Issue:** Client/server rendering mismatches cause React hydration errors

**Common Causes:**
- Date/time rendering (server vs client timezone)
- Random values in render
- Browser-only APIs in server components
- Conditional rendering based on `window`/`localStorage`

**Solutions Applied:**
- ‚úÖ Use `useEffect` for client-only code
- ‚úÖ Use `suppressHydrationWarning` for safe mismatches
- ‚úÖ Ensure consistent data between server and client

**Action Required:**
- Monitor for hydration warnings in production
- Fix any new mismatches as they appear

---

### 6. üîß **Build & Deploy Configuration** (STABILITY)

#### Backend Build Command (Render)
```bash
cd server && npm install --legacy-peer-deps && npm run build
```

#### Backend Start Command (Render)
```bash
cd server && npm start
```

#### Frontend Build Command (Render)
```bash
npm install --legacy-peer-deps && npx prisma generate && npm run build
```

#### Frontend Start Command (Render)
```bash
cd .next/standalone && (test -d ../../public && cp -r ../../public ./public || true) && (test -d ../../.next/static && cp -r ../../.next/static ./.next/static || true) && node server.js
```

**Health Checks:**
- Backend: `/api/health` (should return "OK")
- Frontend: `/health` (should return "OK")

---

## ‚úÖ Pre-Deployment Checklist

### Backend Service
- [ ] All environment variables set in Render Dashboard
- [ ] Database connection string is correct
- [ ] JWT_SECRET is set and secure
- [ ] CORS is configured properly (not allowing all origins)
- [ ] Health check endpoint works (`/api/health`)
- [ ] Build completes successfully
- [ ] Prisma migrations deploy successfully
- [ ] Server starts without errors

### Frontend Service
- [ ] All environment variables set in Render Dashboard
- [ ] NEXT_PUBLIC_API_URL points to backend
- [ ] Build completes successfully
- [ ] Health check endpoint works (`/health`)
- [ ] No hydration mismatches in build logs
- [ ] Static assets copy correctly in start command

### Database
- [ ] PostgreSQL instance is running
- [ ] DATABASE_URL is accessible from Render
- [ ] Schema is up to date
- [ ] Migrations have been applied

### Integration
- [ ] Frontend can connect to backend API
- [ ] CORS allows frontend origin
- [ ] Authentication flow works
- [ ] API routes respond correctly

---

## üêõ Common Deployment Issues & Solutions

### Issue: "Column does not exist"
**Cause:** Schema out of sync, migration not applied  
**Solution:**
```bash
# In Render Shell (Backend service)
cd server
npx prisma db push --schema=./prisma/schema.prisma --accept-data-loss
# OR
npx prisma migrate deploy --schema=./prisma/schema.prisma
```

### Issue: CORS errors (403)
**Cause:** Frontend origin not allowed  
**Solution:**
- Check `FRONTEND_URL` in backend environment variables
- Verify CORS configuration in `server/src/index.ts`
- Remove temporary `if (true)` bypass

### Issue: Hydration Mismatch
**Cause:** Client/server rendering differs  
**Solution:**
- Check for `new Date()`, `Math.random()`, browser APIs in server components
- Use `useEffect` for client-only code
- Add `suppressHydrationWarning` if intentional

### Issue: Build fails with TypeScript errors
**Cause:** Type errors in code  
**Solution:**
- Currently `typescript.ignoreBuildErrors: true` in `next.config.js`
- Fix actual errors or remove this setting

### Issue: Environment variables not available
**Cause:** Variables not set in Render Dashboard  
**Solution:**
- Verify all required variables are set
- Check variable names (case-sensitive)
- Redeploy after adding variables

---

## üìä Monitoring & Health Checks

### Backend Health Check
```bash
curl https://banda-chao-backend.onrender.com/api/health
# Expected: "OK"
```

### Frontend Health Check
```bash
curl https://banda-chao-frontend.onrender.com/health
# Expected: "OK"
```

### Database Connection Check
```bash
# In Render Shell (Backend service)
cd server
npx prisma db execute --stdin
# Type: SELECT 1;
# Expected: Success
```

---

## üîÑ Deployment Workflow

1. **Pre-Deployment**
   - Update environment variables if needed
   - Test migrations locally
   - Verify schema consistency

2. **Deploy Backend**
   - Push to GitHub (triggers auto-deploy on Render)
   - Monitor build logs
   - Verify health check

3. **Deploy Frontend**
   - Push to GitHub (triggers auto-deploy on Render)
   - Monitor build logs
   - Verify health check

4. **Post-Deployment**
   - Test critical user flows
   - Monitor error logs
   - Check database migrations

---

## üìù Next Steps

1. ‚úÖ **Sync Prisma Schemas** - Consolidate to single source of truth
2. ‚úÖ **Fix CORS Configuration** - Remove temporary wildcard allow
3. ‚úÖ **Environment Variable Audit** - Document and validate all vars
4. ‚úÖ **Improve Error Handling** - Better migration error messages
5. ‚úÖ **Add Monitoring** - Set up alerts for deployment failures
6. ‚úÖ **Documentation** - Keep this document updated

---

## üîó Related Documents

- `RENDER_DEPLOYMENT_GUIDE.md` - General Render deployment guide
- `RENDER_ENV_VARIABLES_TEMPLATE.md` - Environment variables template
- `DATABASE_MIGRATION_GUIDE.md` - Database migration procedures
- `DEPLOYMENT_CHECKLIST.md` - Pre-deployment checklist

---

**Last Updated:** January 2025  
**Maintained By:** Development Team
