services:
  # Backend Service (Express API Server)
  - type: web
    name: banda-chao-backend
    env: node
    # Root directory for backend (Render uses rootDir, but we'll specify in buildCommand)
    # Build command for backend - must cd to server directory first
    buildCommand: cd server && npm install --legacy-peer-deps && npm run build
    # Start command for backend (uses compiled dist/index.js)
    # Must cd to server directory first
    startCommand: cd server && npm start
    # Node version
    nodeVersion: 20.x
    # Plan settings
    plan: starter
    # Health check for backend - uses /api/health endpoint
    healthCheckPath: /api/health
    # Auto-deploy
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      # PORT is automatically set by Render - don't override it
      # Render will provide PORT via environment variable (usually 10000)
      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: banda-chao-db
          property: connectionString
      # JWT Secret (should be set manually in Render Dashboard)
      - key: JWT_SECRET
        generateValue: true
      # Frontend URL for CORS
      - key: FRONTEND_URL
        value: https://banda-chao-frontend.onrender.com
      # Stripe (optional - set manually if using)
      # - key: STRIPE_SECRET_KEY
      # - key: STRIPE_PUBLISHABLE_KEY
      # - key: STRIPE_MODE
      #   value: production

  # Frontend Service (Next.js Standalone)
  - type: web
    name: banda-chao-frontend
    env: node
    # Optimized build command for Render (uses standalone output)
    # Using npm install with --legacy-peer-deps to handle peer dependency conflicts
    # npm ci is faster but strict about peer deps, so we use npm install for compatibility
    buildCommand: npm install --legacy-peer-deps && npx prisma generate && npm run build
    # Start command uses standalone server for better performance and lower memory usage
    # CRITICAL: Explicitly copy public and static assets (Next.js sometimes fails to copy them)
    # This ensures all assets are available even if Next.js build misses them
    # Using test -d to check directories exist before copying to avoid errors
    startCommand: cd .next/standalone && (test -d ../../public && cp -r ../../public ./public || true) && (test -d ../../.next/static && cp -r ../../.next/static ./.next/static || true) && node server.js
    # Node version
    nodeVersion: 20.x
    # Plan settings (adjust based on your Render plan)
    plan: starter
    # Health check - use dedicated endpoint for faster response
    healthCheckPath: /health
    # Auto-deploy
    autoDeploy: true
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_FRONTEND_URL
        value: https://banda-chao-frontend.onrender.com
      - key: NEXT_PUBLIC_API_URL
        fromService:
          type: web
          name: banda-chao-backend
          property: host
        # Required for standalone mode
      - key: PORT
        value: 3000
      # NextAuth v5 - Use AUTH_SECRET and AUTH_URL (new variable names)
      - key: AUTH_URL
        value: https://banda-chao-frontend.onrender.com
      - key: AUTH_SECRET
        generateValue: true
      # Legacy support - keep old names for backward compatibility
      - key: NEXTAUTH_URL
        value: https://banda-chao-frontend.onrender.com
      - key: NEXTAUTH_SECRET
        generateValue: true
      # Database (SQLite for local, PostgreSQL for production)
      - key: DATABASE_URL
        fromDatabase:
          name: banda-chao-db
          property: connectionString

