generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Note: In Prisma 7+, URL should be in prisma.config.ts or passed to PrismaClient
  // For now, we'll use the traditional approach compatible with Prisma 6
  url      = env("DATABASE_URL")
}

// ============================================
// USER & PROFILE CORE - الكيانات الأساسية
// ============================================

model users {
  id              String   @id @default(uuid())
  email           String   @unique
  password        String?
  name            String?
  profile_picture String?
  bio             String?
  level           Int      @default(1)
  points          Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  role            String   @default("USER")

  // Social Profile Stats (cached for performance)
  followers_count Int @default(0)
  following_count Int @default(0)
  posts_count     Int @default(0)
  videos_count    Int @default(0)
  products_count  Int @default(0)

  // Relations
  comment_likes                        comment_likes[]
  comments                             comments[]
  follows_follows_follower_idTousers   follows[]             @relation("follows_follower_idTousers")
  follows_follows_following_idTousers  follows[]             @relation("follows_following_idTousers")
  makers                               makers?
  messages_messages_receiver_idTousers messages[]            @relation("messages_receiver_idTousers")
  messages_messages_sender_idTousers   messages[]            @relation("messages_sender_idTousers")
  notifications                        notifications[]
  orders                               orders[]
  post_likes                           post_likes[]
  posts                                posts[]
  product_likes                        product_likes[]
  products                             products[]
  reports                              reports[]
  video_likes                          video_likes[]
  videos                               videos[]
  advisor_sessions                     advisor_sessions[]
  customer_insights                    customer_insights[]
  cart_items                           cart_items[]
  shares                               shares[]
  product_variants                     product_variants[]
  inventory_movements                  inventory_movements[]
  social_accounts                      social_accounts[]

  @@index([email])
  @@index([role])
  @@index([created_at])
}

// ============================================
// E-COMMERCE CORE - الكيانات التجارية
// ============================================

model categories {
  id          String       @id @default(uuid())
  name        String
  name_ar     String?
  name_zh     String?
  slug        String       @unique
  description String?
  image_url   String?
  parent_id   String?
  parent      categories?  @relation("CategoryParent", fields: [parent_id], references: [id], onDelete: SetNull)
  children    categories[] @relation("CategoryParent")
  products    products[]
  created_at  DateTime     @default(now())
  updated_at  DateTime     @updatedAt

  @@index([slug])
  @@index([parent_id])
}

model products {
  id             String      @id @default(uuid())
  name           String
  name_ar        String?
  name_zh        String?
  title          String?
  description    String
  description_ar String?
  description_zh String?
  image_url      String?
  external_link  String?
  video_url      String?
  user_id        String
  category_id    String?
  category       categories? @relation(fields: [category_id], references: [id], onDelete: SetNull)
  price          Float?
  original_price Float?
  currency       String      @default("USD")
  stock          Int         @default(0)
  sold_count     Int         @default(0)
  views_count    Int         @default(0)
  rating         Float?      @default(0)
  reviews_count  Int         @default(0)
  status         String      @default("ACTIVE") // ACTIVE, INACTIVE, DRAFT, OUT_OF_STOCK
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt

  // Relations
  comments          comments[]
  group_buys        group_buys[]
  order_items       order_items[]
  product_likes     product_likes[]
  users             users               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  variants          product_variants[]
  inventory         inventory_items[]
  post_products     post_products[]
  video_products    video_products[]
  supplier_products supplier_products[]
  cart_items        cart_items[]

  @@index([category_id])
  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@index([sold_count])
}

model product_variants {
  id         String   @id @default(uuid())
  product_id String
  product    products @relation(fields: [product_id], references: [id], onDelete: Cascade)
  name       String // e.g., "Size: Large", "Color: Red"
  name_ar    String?
  name_zh    String?
  sku        String?  @unique
  price      Float?
  stock      Int      @default(0)
  image_url  String?
  created_by String
  users      users    @relation(fields: [created_by], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([product_id])
  @@index([sku])
}

model cart_items {
  id         String   @id @default(uuid())
  user_id    String
  product_id String
  variant_id String?
  quantity   Int      @default(1)
  price      Float // Snapshot price at add time
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  products   products @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([user_id, product_id, variant_id])
  @@index([user_id])
  @@index([product_id])
}

model orders {
  id                   String             @id @default(uuid())
  user_id              String
  status               String             @default("PENDING")
  totalAmount          Float
  subtotal             Float
  shipping_cost        Float              @default(0)
  tax                  Float              @default(0)
  currency             String             @default("USD")
  shipping_address     String?
  shipping_city        String?
  shipping_country     String?
  shipping_phone       String?
  shipping_name        String?
  shipping_postal_code String?
  created_at           DateTime           @default(now())
  updated_at           DateTime           @updatedAt
  stripe_id            String?
  payment_method       String?
  order_items          order_items[]
  users                users              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  coordinator_logs     coordinator_logs[]

  @@index([created_at])
  @@index([status])
  @@index([stripe_id])
  @@index([user_id])
}

model order_items {
  id         String   @id @default(uuid())
  order_id   String
  product_id String
  variant_id String?
  quantity   Int      @default(1)
  price      Float
  created_at DateTime @default(now())
  orders     orders   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  products   products @relation(fields: [product_id], references: [id])

  @@index([order_id])
  @@index([product_id])
}

// ============================================
// SUPPLIERS & INVENTORY - الموردين والمخزون
// ============================================

model suppliers {
  id             String   @id @default(uuid())
  name           String
  name_ar        String?
  name_zh        String?
  email          String?
  phone          String?
  address        String?
  country        String?
  city           String?
  contact_person String?
  status         String   @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  rating         Float?   @default(0)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  supplier_products   supplier_products[]
  inventory_movements inventory_movements[]

  @@index([status])
  @@index([country])
}

model supplier_products {
  id             String    @id @default(uuid())
  supplier_id    String
  product_id     String
  supplier_sku   String?
  cost_price     Float
  min_order_qty  Int       @default(1)
  lead_time_days Int       @default(7)
  status         String    @default("ACTIVE")
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt
  suppliers      suppliers @relation(fields: [supplier_id], references: [id], onDelete: Cascade)
  products       products  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([supplier_id, product_id])
  @@index([supplier_id])
  @@index([product_id])
}

model inventory_items {
  id           String   @id @default(uuid())
  product_id   String
  variant_id   String?
  quantity     Int      @default(0)
  reserved_qty Int      @default(0) // Reserved for pending orders
  location     String? // Warehouse location
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  products     products @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([product_id, variant_id, location])
  @@index([product_id])
}

model inventory_movements {
  id            String     @id @default(uuid())
  product_id    String?
  variant_id    String?
  supplier_id   String?
  user_id       String?
  movement_type String // IN, OUT, ADJUSTMENT, RETURN
  quantity      Int
  reason        String?
  reference_id  String? // Order ID, etc.
  created_at    DateTime   @default(now())
  suppliers     suppliers? @relation(fields: [supplier_id], references: [id], onDelete: SetNull)
  users         users?     @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([product_id])
  @@index([movement_type])
  @@index([created_at])
}

// ============================================
// SOCIAL MEDIA CORE - الكيانات الاجتماعية
// ============================================

model posts {
  id             String          @id @default(uuid())
  content        String
  content_ar     String?
  content_zh     String?
  user_id        String
  images         String? // JSON array stored as string
  location       String?
  is_pinned      Boolean         @default(false)
  views_count    Int             @default(0)
  likes_count    Int             @default(0)
  comments_count Int             @default(0)
  shares_count   Int             @default(0)
  // Mirror System - External Platform Integration
  external_id    String? // ID on external platform (TikTok, YouTube, etc.)
  platform       String? // TIKTOK, YOUTUBE, INSTAGRAM, etc.
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt
  post_likes     post_likes[]
  post_products  post_products[]
  users          users           @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([created_at])
  @@index([is_pinned])
  @@index([platform, external_id])
}

model post_products {
  id          String   @id @default(uuid())
  post_id     String
  product_id  String
  position    Int? // Position in post (for multiple products)
  is_featured Boolean  @default(false) // Main product in post
  created_at  DateTime @default(now())
  posts       posts    @relation(fields: [post_id], references: [id], onDelete: Cascade)
  products    products @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([post_id, product_id])
  @@index([post_id])
  @@index([product_id])
}

model videos {
  id             String           @id
  user_id        String
  title          String
  title_ar       String?
  title_zh       String?
  description    String?
  description_ar String?
  description_zh String?
  video_url      String
  thumbnail_url  String
  duration       Int
  type           String // SHORT, LONG, LIVE
  views          Int              @default(0)
  likes          Int              @default(0)
  comments_count Int              @default(0)
  shares_count   Int              @default(0)
  // Mirror System - External Platform Integration
  external_id    String? // ID on external platform (TikTok, YouTube, etc.)
  platform       String? // TIKTOK, YOUTUBE, INSTAGRAM, etc.
  created_at     DateTime         @default(now())
  updated_at     DateTime         @updatedAt
  comments       comments[]
  video_likes    video_likes[]
  video_products video_products[]
  users          users            @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([type])
  @@index([user_id])
  @@index([platform, external_id])
}

model video_products {
  id          String   @id @default(uuid())
  video_id    String
  product_id  String
  timestamp   Int? // Video timestamp where product appears
  position    Int? // Position in video (for multiple products)
  is_featured Boolean  @default(false)
  created_at  DateTime @default(now())
  videos      videos   @relation(fields: [video_id], references: [id], onDelete: Cascade)
  products    products @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([video_id, product_id])
  @@index([video_id])
  @@index([product_id])
}

model shares {
  id          String   @id @default(uuid())
  user_id     String
  target_type String // POST, VIDEO, PRODUCT
  target_id   String
  platform    String? // FACEBOOK, TWITTER, WHATSAPP, etc.
  created_at  DateTime @default(now())
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([target_type, target_id])
  @@index([created_at])
}

model post_likes {
  id         String   @id
  user_id    String
  post_id    String
  created_at DateTime @default(now())
  posts      posts    @relation(fields: [post_id], references: [id], onDelete: Cascade)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, post_id])
  @@index([post_id])
  @@index([user_id])
}

model video_likes {
  id         String   @id
  user_id    String
  video_id   String
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  videos     videos   @relation(fields: [video_id], references: [id], onDelete: Cascade)

  @@unique([user_id, video_id])
  @@index([user_id])
  @@index([video_id])
}

model product_likes {
  id         String   @id
  user_id    String
  product_id String
  created_at DateTime @default(now())
  products   products @relation(fields: [product_id], references: [id], onDelete: Cascade)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, product_id])
  @@index([product_id])
  @@index([user_id])
}

model comments {
  id            String          @id
  user_id       String
  video_id      String?
  product_id    String?
  post_id       String?
  content       String
  likes         Int             @default(0)
  created_at    DateTime        @default(now())
  updated_at    DateTime
  comment_likes comment_likes[]
  products      products?       @relation(fields: [product_id], references: [id], onDelete: Cascade)
  users         users           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  videos        videos?         @relation(fields: [video_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([product_id])
  @@index([user_id])
  @@index([video_id])
  @@index([post_id])
}

model comment_likes {
  id         String   @id
  user_id    String
  comment_id String
  created_at DateTime @default(now())
  comments   comments @relation(fields: [comment_id], references: [id], onDelete: Cascade)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, comment_id])
  @@index([comment_id])
  @@index([user_id])
}

model follows {
  id                                String   @id
  follower_id                       String
  following_id                      String
  created_at                        DateTime @default(now())
  users_follows_follower_idTousers  users    @relation("follows_follower_idTousers", fields: [follower_id], references: [id], onDelete: Cascade)
  users_follows_following_idTousers users    @relation("follows_following_idTousers", fields: [following_id], references: [id], onDelete: Cascade)

  @@unique([follower_id, following_id])
  @@index([follower_id])
  @@index([following_id])
}

// ============================================
// SOCIAL ACCOUNTS - حسابات المنصات الخارجية
// ============================================

model social_accounts {
  id                String   @id @default(uuid())
  user_id           String
  platform          String   // TIKTOK, YOUTUBE, INSTAGRAM, FACEBOOK, TWITTER
  platform_user_id  String?  // User ID on the external platform
  access_token      String   // Encrypted access token
  refresh_token     String?  // Encrypted refresh token
  token_expires_at  DateTime? // Token expiration time
  is_active         Boolean  @default(true)
  metadata          String?  // JSON stored as string (profile info, permissions, etc.)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  users             users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, platform])
  @@index([user_id])
  @@index([platform])
  @@index([is_active])
}

// ============================================
// AI TRINITY BRAIN - الكيانات الذكية
// ============================================

model advisor_sessions {
  id               String             @id @default(uuid())
  user_id          String?
  session_type     String             @default("ANALYSIS")
  context          String? // JSON stored as string
  status           String             @default("ACTIVE")
  created_at       DateTime           @default(now())
  updated_at       DateTime           @updatedAt
  completed_at     DateTime?
  users            users?             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  advisor_analyses advisor_analyses[]

  @@index([user_id])
  @@index([session_type])
  @@index([status])
  @@index([created_at])
}

model advisor_analyses {
  id               String            @id @default(uuid())
  session_id       String?
  analysis_type    String // MARKET_TREND, USER_BEHAVIOR, PRODUCT_PERFORMANCE, COMPETITOR
  category         String?
  region           String?
  data             String // JSON stored as string
  insights         String? // AI-generated insights
  confidence_score Float? // 0.0 to 1.0
  created_at       DateTime          @default(now())
  updated_at       DateTime          @updatedAt
  advisor_sessions advisor_sessions? @relation(fields: [session_id], references: [id], onDelete: SetNull)

  @@index([analysis_type])
  @@index([category])
  @@index([created_at])
}

model customer_insights {
  id          String   @id @default(uuid())
  user_id     String
  event_type  String
  target_id   String?
  target_type String?
  metadata    String? // JSON stored as string
  session_id  String?
  created_at  DateTime @default(now())
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([event_type])
  @@index([target_id, target_type])
  @@index([created_at])
  @@index([user_id, created_at])
}

model pricing_rules {
  id          String    @id @default(uuid())
  rule_name   String    @unique
  rule_type   String // DYNAMIC, DISCOUNT, SURGE, SEASONAL
  product_id  String?
  category_id String?
  conditions  String // JSON stored as string
  actions     String // JSON stored as string
  priority    Int       @default(0)
  is_active   Boolean   @default(true)
  valid_from  DateTime?
  valid_until DateTime?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  @@index([rule_type])
  @@index([is_active])
  @@index([priority])
  @@index([product_id])
  @@index([category_id])
}

model coordinator_logs {
  id            String   @id @default(uuid())
  order_id      String?
  action_type   String // ORDER_PROCESSED, INVENTORY_UPDATED, SUPPLIER_NOTIFIED, SHIPPING_ARRANGED, CONTENT_SYNCED
  status        String // SUCCESS, FAILED, PENDING
  details       String? // JSON stored as string
  error_message String?
  // Mirror System - Content Sync Tracking
  content_type  String? // VIDEO, POST
  content_id    String? // ID of video or post
  platform      String? // TIKTOK, YOUTUBE, etc.
  created_at    DateTime @default(now())
  orders        orders?  @relation(fields: [order_id], references: [id], onDelete: SetNull)

  @@index([order_id])
  @@index([action_type])
  @@index([status])
  @@index([created_at])
  @@index([content_type, content_id])
  @@index([platform])
}

// ============================================
// OTHER MODELS - نماذج أخرى
// ============================================

model makers {
  id                  String   @id
  user_id             String   @unique
  slug                String   @unique
  name                String
  bio                 String?
  story               String?
  profile_picture_url String?
  cover_picture_url   String?
  created_at          DateTime @default(now())
  updated_at          DateTime
  users               users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model group_buys {
  id        String   @id
  productId String
  status    String   @default("OPEN")
  createdAt DateTime @default(now())
  expiresAt DateTime
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([productId])
  @@index([status])
}

model messages {
  id                                String   @id
  content                           String
  sender_id                         String
  receiver_id                       String
  timestamp                         DateTime @default(now())
  read                              Boolean  @default(false)
  users_messages_receiver_idTousers users    @relation("messages_receiver_idTousers", fields: [receiver_id], references: [id], onDelete: Cascade)
  users_messages_sender_idTousers   users    @relation("messages_sender_idTousers", fields: [sender_id], references: [id], onDelete: Cascade)

  @@index([sender_id, receiver_id])
}

model notifications {
  id         String   @id
  user_id    String
  type       String
  title      String
  body       String?
  data       String? // JSON stored as string
  is_read    Boolean  @default(false)
  created_at DateTime @default(now())
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([is_read])
  @@index([user_id])
  @@index([user_id, is_read, created_at])
}

model reports {
  id          String   @id
  user_id     String
  target_id   String
  target_type String
  reason      String
  resolved    Boolean  @default(false)
  created_at  DateTime @default(now())
  users       users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([resolved])
  @@index([target_id, target_type])
  @@index([user_id])
}

model beta_applications {
  id             Int      @id @default(autoincrement())
  name           String
  email          String
  country        String
  main_platform  String?
  what_you_sell  String?
  preferred_lang String?
  why_join       String?
  created_at     DateTime @default(now())

  @@index([email])
  @@index([created_at])
}
